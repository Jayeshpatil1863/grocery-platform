{% load static %}
{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Grocery Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
    body { 
        background: #f8f9fa; 
        min-height: 100vh; 
        overflow-y: auto;  /* scroll enable */
    }

    h2 { 
        color: #0d6efd; 
        font-weight: 700; 
    }

    .total-section { 
        background: #fff; 
        border-radius: 10px; 
        box-shadow: 0 3px 10px rgba(0,0,0,0.1); 
        padding: 20px; 
    }

    .container {
        padding-bottom: 120px; /* Button safe zone */
    }
</style>

</head>
<body>

<div class="container mt-4">
    <h2 class="text-center mb-4">ðŸ›’ Checkout</h2>

    <form method="POST" action="{% url 'orderapp:checkout' %}">
        {% csrf_token %}

        <input type="hidden" name="add_new_address" id="add_new_address" value="no">

        <div class="total-section mb-4">
            <h4>Total: <span class="text-success">â‚¹{{ total }}</span></h4>

            <label class="fw-bold">Select Delivery Slot:</label>
            {{ order_form.delivery_slot|add_class:"form-select" }}
        </div>

        <h4 class="mb-2">Select Delivery Address</h4>

        {% if addresses %}
            {% for addr in addresses %}
            <div class="card p-3 mb-2">
                <label style="cursor:pointer">
                    <input type="radio" name="selected_address" value="{{ addr.id }}" required>
                    <strong>{{ addr.full_name }}</strong><br>
                    {{ addr.address_line }}, {{ addr.city }} - {{ addr.pincode }} <br>
                    Phone: {{ addr.phone }}
                </label>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No saved addresses found.</p>
        {% endif %}

        <div class="form-check mt-3">
            <input type="checkbox" class="form-check-input" id="add_new" onclick="toggleAddress()">
            <label class="form-check-label fw-bold">Add New Address</label>
        </div>

        <div id="new_address" style="display:none;" class="mt-3">
            {{ address_form.as_p }}
        </div>

        <button type="submit" class="btn btn-success mt-4 mb-4 w-100">Save Order</button>


    </form>
</div>

<script>
function toggleAddress() {
    let newAddressBox = document.getElementById("new_address");
    // Naye form ke saare inputs, selects, aur textareas ko target karo
    let newAddressInputs = newAddressBox.querySelectorAll('input, select, textarea');
    let hiddenFlag = document.getElementById("add_new_address");
    let checkbox = document.getElementById("add_new");
    // Purane address ke saare radio buttons ko target karo
    let oldAddressRadios = document.querySelectorAll('input[name="selected_address"]');

    if (checkbox.checked) {
        // ---- JAB "ADD NEW" CHECKED HAI ----
        newAddressBox.style.display = "block";
        hiddenFlag.value = "yes";

        // 1. Naye form ke inputs ko ENABLE karo (taaki yeh validate ho sake)
        newAddressInputs.forEach(input => input.disabled = false);

        // 2. Purane address wale radio buttons ko DISABLE karo
        oldAddressRadios.forEach(radio => {
            radio.disabled = true;
            radio.checked = false; // Selection bhi hata do
        });

    } else {
        // ---- JAB "ADD NEW" UNCHECKED HAI ----
        newAddressBox.style.display = "none";
        hiddenFlag.value = "no";

        // 1. (YEH HAI FIX) Naye form ke inputs ko DISABLE karo
        // Isse browser inko validation ke liye check nahi karega
        newAddressInputs.forEach(input => input.disabled = true);

        // 2. Purane address wale radio buttons ko ENABLE karo (taaki yeh select ho sake)
        oldAddressRadios.forEach(radio => radio.disabled = false);
    }
}

// YEH BHI IMPORTANT HAI: Page load hote hi function ko ek baar run karo
// Taa ki by default new address form disabled rahe
document.addEventListener("DOMContentLoaded", function() {
    // Shuru mein hi naye address form ke inputs ko disable kar do
    let newAddressInputs = document.getElementById("new_address").querySelectorAll('input, select, textarea');
    newAddressInputs.forEach(input => input.disabled = true);

    // Agar koi old address nahi hai, toh new address form ko by default
    // checked aur enabled rakho
    let oldAddressRadios = document.querySelectorAll('input[name="selected_address"]');
    if (oldAddressRadios.length === 0) {
        let checkbox = document.getElementById("add_new");
        checkbox.checked = true;
        checkbox.disabled = true; // User ko uncheck na karne dein agar koi old address nahi hai
        toggleAddress(); // Function ko call karo taaki form dikhe aur enable ho
    }
});
</script>
</body>
</html>